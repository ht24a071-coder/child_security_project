# =============================================================================
# 踏切イベント（連打ミニゲーム付き）
# =============================================================================

label safe_e_railway:
    play sound "audio/humikiri.mp3" loop

    pc "あ、ふみきりだ。"
    "カンカンカンカン……"
    "けいほうきが なりはじめ、しゃだんきが おりてきた！"

    menu:
        "いそいで はしりぬける！":
            jump .choice_dash

        "たちどまって まつ":
            jump .choice_wait

        "てを あげて じゅんびする":
            jump .choice_hand

# -----------------------------------------------------------------------------
# 走り抜けるルート（連打ミニゲーム→危険を体験）
# -----------------------------------------------------------------------------
label .choice_dash:
    pc "いまなら まだ まにあうはず……！"
    
    # 連打ミニゲーム
    "（れんだ！スペースキーを れんだして わたれ！）"
    
    python:
        dash_game = MashingMinigame(target_count=15, time_limit=2.5, key="K_SPACE")
    
    call screen mashing_minigame(dash_game)
    
    # どの結果でも危険な行動だったことを伝える
    play audio "audio/crash.mp3" 
    "ガタン！！"
    pc "うわっ！？"
    "ころんでしまった！"
    
    stop sound fadeout 1.0
    
    pc "（あぶなかった……。）"
    
    "{i}ふみきりが なっているときは、ぜったいに わたってはいけないよ！{/i}"
    "{i}でんしゃは きゅうには とまれないんだ。{/i}"
    
    $ update_score(-10)
    
    jump .event_end

# -----------------------------------------------------------------------------
# 待つルート（正解）
# -----------------------------------------------------------------------------
label .choice_wait:
    $ update_score(10)
    
    pc "あぶないから まっていよう。"

    play sound "audio/train.mp3"

    "……ガタンゴトン、ガタンゴトン……"
    "めのまえを でんしゃが とおりすぎていった。"

    pause 2.0
    stop sound fadeout 1.0

    "しゃだんきが あがった。"
    pc "よし、もう わたっても だいじょうぶだね。"
    
    "{i}よくできました！ふみきりでは かならず とまって まとうね。{/i}"
    
    jump .event_end

# -----------------------------------------------------------------------------
# 手を上げて準備ルート（ベスト回答）
# -----------------------------------------------------------------------------
label .choice_hand:
    $ update_score(15)
    
    pc "まずは しゃだんきが あがるのを まとう。"
    
    play sound "audio/train.mp3"
    "……ガタンゴトン……"
    pause 2.0
    stop sound fadeout 1.0
    
    "しゃだんきが あがった。"
    
    # タイミングゲーム
    "（さゆうを かくにん！タイミングよく スペースキーを おそう！）"
    
    python:
        check_game = TimingMinigame(speed=3.0, perfect_range=40, good_range=70, key="K_SPACE")
    
    call screen timing_minigame(check_game)
    
    if _return == "perfect":
        $ update_score(10)
        pc "てを あげて、さゆうを かくにん！よし！"
        "PERFECT!! かんぺきな かくにんだ！"
    elif _return == "good":
        $ update_score(5)
        pc "てを あげて、さゆうを かくにん！"
        "GOOD! ちゃんと かくにんできたね！"
    else:
        pc "さゆうを…あ、かくにん できなかった…"
        "もう すこし しっかり かくにんしよう！"
    
    "しっかり てを あげて わたった。"
    
    "{i}すばらしい！てを あげると うんてんしゅさんから よく みえるよ！{/i}"
    
    jump .event_end

# -----------------------------------------------------------------------------
# イベント終了
# -----------------------------------------------------------------------------
label .event_end:
    stop sound fadeout 1.0
    "もとの みちに もどろう。"
    return