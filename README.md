# ゲームで学ぶ！防犯ゲーム

子供向けの防犯教育を目的としたアドベンチャーゲームです。
マップを探索しながら家に帰る過程で、不審者遭遇イベントや防犯クイズが発生します。
展示会等での試遊を想定し、タッチ操作対応や放置時の自動リセット機能を実装しています。

## 🛠 開発環境
- エンジン: Ren'Py
- 言語: Ren'Py Script (Pythonベース)
- エディタ: VS Code

## 📂 ファイル構成と役割
主要なコードは `child_security_project/game/` フォルダ内にあります。機能ごとにファイルを分割して管理しています。

### メインファイル

| ファイル名 | 役割 | 備考 |
| --- | --- | --- |
| **script.rpy** | ゲーム進行のメインループ | 登校・下校両モード対応。`travel_loop` でマップ移動を制御。 |
| **def_mapdat.rpy** | マップ・イベントデータ管理 | 地点のつながり(world_map)や、発生するイベントプール(event_pools)を管理。 |
| **definitions.rpy** | 定数・変数・スコア管理 | キャラクター定義、スコアHUD、スコアポップアップ演出など。 |
| **data_lists.rpy** | データリスト管理 | 二つ名用単語リスト、アバターアイコンリスト、セリフテーブルなど。 |
| **screens.rpy** | 画面デザイン (UI) | プロフィール設定、放置対策(inactivity_guard)、タイトル画面など。 |
| **options.rpy** | ゲーム全体の設定 | 画面サイズ、音量、ビルド設定など。 |

### ミニゲーム (minigames/)

| ファイル名 | 役割 | 備考 |
| --- | --- | --- |
| **minigame.rpy** | ミニゲーム集 | タイミングゲーム(TimingMinigame)、連打ゲーム(MashingMinigame)、脱出ゲーム(EscapeMinigame)。 |
| **minigame_mic.rpy** | おおごえミニゲーム | Windows APIを使ったマイク音量検出(WinMicRecorder)とおおごえミニゲーム(ShoutMinigame)。 |

### イベント (events/)

| ファイル名 | 役割 |
| --- | --- |
| **event_encounter_safe.rpy** | 安全な人との遭遇イベント（挨拶イベントなど） |
| **event_encounter_danger.rpy** | 不審者遭遇イベント |
| **event_car_abduction.rpy** | 車による声掛けイベント |
| **event_daily_110house.rpy** | 110番の家発見イベント |
| **events_railway.rpy** | 踏切イベント |
| **safe_event_1.rpy / safe_event_2.rpy** | 安全イベント |
| **suspicious_event_1.rpy / suspicious_event_2.rpy** | 不審イベント |
| **special_event_*.rpy** | 特別イベント |

### 画面系

| ファイル名 | 役割 |
| --- | --- |
| **screens_feedback.rpy** | ゲームクリア/ゲームオーバー時のフィードバック画面 |
| **screens_ranking.rpy** | ランキング表示画面 |
| **ranking_system.rpy** | ランキングシステム（二つ名生成・スコア保存） |

## ✨ 主な実装機能

### 1. マップ探索システム (`def_mapdat.rpy`, `script.rpy`)
- **ノードベース移動**: `world_map` に定義された地点（ノード）を選択肢として移動します。
- **登校・下校モード**: `going_school_start` と `going_home_start` で両方向に対応。
- **イベント抽選**:
    - 各地点には「safe」「suspicious」「crossing」などのグループが設定されています。
    - 移動時に確率（chance）で `event_pools` から未読のイベントが抽選・実行されます。

### 2. プロフィール生成 (`screens.rpy`, `data_lists.rpy`)
- **二つ名システム**: 3パートの単語リスト（形容詞・属性・名詞）を組み合わせて、ユニークなプレイヤー名を自動/手動設定。
- **アバター選択**: 30種類の動物アイコンからプレイヤーの見た目を選択可能。

### 3. スコアシステム (`definitions.rpy`)
- **スコアHUD**: 画面左上にスコアを常時表示。
- **ポップアップ演出**: 得点変動時にプラス/マイナスのアニメーション付きポップアップを表示。
- **update_score関数**: スコア更新と演出を一括処理。

### 4. ミニゲーム (`minigames/`)
- **タイミングミニゲーム**: 鍵開け時のタイミングゲーム。Perfect/Good/Missの3段階判定。
- **連打ミニゲーム**: 制限時間内にスペースキーを連打してゲージを溜める。
- **脱出ミニゲーム**: 難易度調整可能なタイミングゲーム。
- **おおごえミニゲーム**: Windows APIを使ったマイク入力で音量を検出。非対応環境では連打ゲームにフォールバック。

### 5. ランキングシステム (`ranking_system.rpy`, `screens_ranking.rpy`)
- **スコア記録**: ゲームクリア時に二つ名付きでスコアを保存。
- **重複チェック**: 同一プレイヤーの場合はスコア更新確認を表示。
- **上位10件保持**: スコア順にソートし、上位10件のみを永続保存。

### 6. フィードバック画面 (`screens_feedback.rpy`)
- **ゲームクリア/ゲームオーバー表示**: スコアに応じたメッセージとアドバイスを表示。
- **「いかのおすし」教育**: ゲームオーバー時に防犯標語を表示。

### 7. 展示用・放置対策 (`screens.rpy`)
- **inactivity_guard**: ゲーム中に一定時間操作がない場合、自動的にタイトル画面に戻り、次の試遊者がスムーズに始められるようにしています。

## 🚀 実行方法
1. Ren'Py Launcher を起動。
2. プロジェクト一覧から `child_security_project` を選択。
3. 「プロジェクトを起動」をクリック。

## 📝 開発メモ
- **イベントの追加**: 新しいイベントラベルを作成し、`def_mapdat.rpy` の `event_pools` に追加することで抽選対象になります。
- **ミニゲームの追加**: `minigames/` フォルダに新しいクラスと画面を追加してください。
- **画像ファイルは** `game/images/` 以下にルールに従って格納してください。
- **マイク機能**: Windows環境でのみ動作します。ctypesでWindows Multimedia API (winmm.dll) を直接呼び出しています。