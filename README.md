# ゲームで学ぶ！防犯ゲーム

子供向けの防犯教育を目的としたアドベンチャーゲームです。
マップを探索しながら家に帰る過程で、不審者遭遇イベントや防犯クイズが発生します。
展示会等での試遊を想定し、タッチ操作対応や放置時の自動リセット機能を実装しています。

## 🛠 開発環境
- エンジン: Ren'Py
- 言語: Ren'Py Script (Pythonベース)
- エディタ: VS Code

## 📂 ファイル構成と役割
主要なコードは `child_security_project/game/` フォルダ内にあります。機能ごとにファイルを分割して管理しています。

### メインファイル

| ファイル名 | 役割 | 備考 |
| --- | --- | --- |
| **script.rpy** | ゲーム進行のメインループ | 登校・下校両モード対応。`travel_loop` でマップ移動を制御。 |
| **def_mapdat.rpy** | マップ・イベントデータ管理 | 地点のつながり(world_map)や、発生するイベントプール(event_pools)を管理。 |
| **definitions.rpy** | 定数・変数・スコア管理 | キャラクター定義、スコアHUD、スコアポップアップ演出など。 |
| **data_lists.rpy** | データリスト管理 | 二つ名用単語リスト、アバターアイコンリスト、セリフテーブルなど。 |
| **screens.rpy** | 画面デザイン (UI) | プロフィール設定、放置対策(inactivity_guard)、タイトル画面など。 |
| **options.rpy** | ゲーム全体の設定 | 画面サイズ、音量、ビルド設定など。 |

### ミニゲーム (minigames/)

| ファイル名 | 役割 | 備考 |
| --- | --- | --- |
| **minigame.rpy** | ミニゲーム集 | タイミングゲーム(TimingMinigame)、連打ゲーム(MashingMinigame)、脱出ゲーム(EscapeMinigame)。 |
| **minigame_mic.rpy** | おおごえミニゲーム | Windows APIを使ったマイク音量検出(WinMicRecorder)とおおごえミニゲーム(ShoutMinigame)。 |

### イベント (events/)

| ファイル名 | 役割 |
| --- | --- |
| **event_encounter_safe.rpy** | 安全な人との遭遇イベント（挨拶イベントなど） |
| **event_encounter_danger.rpy** | 不審者遭遇イベント |
| **event_car_abduction.rpy** | 車による声掛けイベント |
| **event_daily_110house.rpy** | 110番の家発見イベント |
| **events_railway.rpy** | 踏切イベント |
| **safe_event_1.rpy / safe_event_2.rpy** | 安全イベント |
| **suspicious_event_1.rpy / suspicious_event_2.rpy** | 不審イベント |
| **special_event_*.rpy** | 特別イベント |

### 画面系

| ファイル名 | 役割 |
| --- | --- |
| **screens_feedback.rpy** | ゲームクリア/ゲームオーバー時のフィードバック画面 |
| **screens_ranking.rpy** | ランキング表示画面 |
| **ranking_system.rpy** | ランキングシステム（二つ名生成・スコア保存） |

## ✨ 主な実装機能

### 1. マップ探索システム (`def_minimap.rpy`, `script.rpy`)
- **ノードベース移動**: `world_map` に定義された地点（ノード）を選択肢として移動します。
- **フルスクリーンマップ**: `def_minimap.rpy` で実装。ミニマップをクリックまたはキーボード[M]/コントローラー[Y]で拡大表示可能。
- **ビジュアル強化**:
    - **カラーコーディング**: 行き先ノードの種類（安全・危険・イベント等）に応じた色分け（青・オレンジ・赤など）。
    - **カスタムマーカー**: ユーザー提供のアイコン画像を使用し、視認性を向上。
    - **ズーム調整**: マーカーサイズを調整し、重要な場所（自宅など）を強調。
- **登校・下校モード**: `going_school_start` と `going_home_start` で両方向に対応。
- **イベント抽選**: 移動時に確率で `event_pools` からイベントが発生。

### 2. UI・操作性 (`screens.rpy`)
- **クイックメニュー**: 画面下部のメニューバーはデフォルト非表示。L1ボタン/Tabキーで表示/非表示を切り替え可能。
- **コントローラーガイド**: ゲームパッド接続時に操作ガイドを表示。レイアウト調整済み。
- **フォント対応**: 豆腐（文字化け）対策として、適切なフォント設定を適用。

### 3. プロフィール生成 (`screens.rpy`, `data_lists.rpy`)
- **二つ名システム**: 3パートの単語リストを組み合わせたユニークな名前生成。
- **アバター選択**: 30種類の動物アイコンから選択可能。

### 4. スコアシステム (`definitions.rpy`)
- **スコアHUD**: 画面左上に常時表示。
- **ポップアップ演出**: イベントでのスコア変動時にアニメーション付きで増減を表示。

### 5. ミニゲーム (`minigames/`)
- **タイミング**: 鍵開け等のタイミング合わせ。
- **連打**: 逃走時などの連打アクション。
- **脱出**: 障害物を避けるアクション要素。
- **おおごえ**: Windows API (winmm.dll) を使用したマイク音量検知。非対応時は連打にフォールバック。

### 6. ランキング・フィードバック
- **ランキング**: クリア時にスコアを記録・表示。
- **フィードバック**: クリア/ゲームオーバー時に防犯アドバイス（「いかのおすし」等）を表示。
- **放置対策**: 展示用機能として、一定時間無操作で自動リセット。

## 🚀 実行方法
1. Ren'Py Launcher を起動。
2. プロジェクト一覧から `child_security_project` を選択。
3. 「プロジェクトを起動」をクリック。

## 📝 開発メモ
- **イベント追加**: `def_minimap.rpy` の `event_pools` に追記。
- **画像追加**: `game/images/` 以下に配置。
- **マイク機能**: Windows環境専用（ctypes使用）。
- **マップ調整**: 
    - マーカー位置やズーム率は `def_minimap.rpy` の `minimap_config` や `screen fullscreen_map` で調整可能。
    - パン（ドラッグ移動）やホバー機能は、ユーザビリティの観点から現在無効化（シンプルな挙動に統一）されています。